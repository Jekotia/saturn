services:
  karakeep.app:
    image: ghcr.io/karakeep-app/karakeep:0.26.0
    container_name: karakeep.app
    restart: unless-stopped
    networks:
      - karakeep
      - proxy_private
    volumes:
      - /srv/application_data/karakeep/app/data:/data
    environment:
      MEILI_ADDR: http://karakeep.meilisearch:7700
      BROWSER_WEB_URL: http://karakeep.chrome:9222
      #OPENAI_API_KEY: ${OPENAI_API_KEY}

      OLLAMA_BASE_URL: http://draewyn.saturn.jekotia.net:11434
      # Make sure to pull the models in ollama first. Example models:
      INFERENCE_TEXT_MODEL: gemma3
      INFERENCE_IMAGE_MODEL: llava
      # If the model you're using doesn't support structured output, you also need:
      # INFERENCE_OUTPUT_SCHEMA=plain

      # You almost never want to change the value of the DATA_DIR variable.
      # If you want to mount a custom directory, change the volume mapping above instead.
      DATA_DIR: /data # DON'T CHANGE THIS
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}

      # OIDC via Authentik is below
      NEXTAUTH_URL: https://${KARAKEEP_URL_PREFIX:-karakeep.}${NETWORK_DOMAIN}
      OAUTH_CLIENT_ID: ${OAUTH_CLIENT_ID}
      OAUTH_CLIENT_SECRET: ${OAUTH_CLIENT_SECRET}
      OAUTH_WELLKNOWN_URL: https://auth.${NETWORK_DOMAIN}/application/o/karakeep/.well-known/openid-configuration
      OAUTH_PROVIDER_NAME: authentik
      OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING: true
      # Optional: You can add this if you only want to allow login with Authentik
      DISABLE_PASSWORD_AUTH: true
      # Optional but highly recommended:
      DISABLE_SIGNUPS: true
    labels:
      # Glance
      glance.name: Karakeep
      glance.icon: sh:karakeep
      glance.url: https://${KARAKEEP_URL_PREFIX:-karakeep.}${NETWORK_DOMAIN}
      glance.description: Read-it-later with AI summaries & tagging
      glance.category: personal
      glance.id: karakeep
      # What's Up Docker
      wud.watch: true
      wud.watch.digest: false
      wud.display.icon: sh:karakeep-light
      wud.tag.include: ^\d+\.\d+\.\d+$$
      # Traefik
      traefik.enable: "true"
      # Traefik, Router
      traefik.http.routers.karakeep.entrypoints: websecure
      traefik.http.routers.karakeep.rule: Host(`${KARAKEEP_URL_PREFIX:-karakeep.}${NETWORK_DOMAIN}`)
      traefik.http.routers.karakeep.tls.certresolver: dns-cloudflare
      # Traefik, Services
      traefik.http.routers.karakeep.service: karakeep
      traefik.http.services.karakeep.loadbalancer.server.port: 3000
