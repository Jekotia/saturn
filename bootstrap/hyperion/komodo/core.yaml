services:
  komodo.core:
    image: ghcr.io/moghtech/komodo-core:1.18.4
    container_name: komodo.core
    restart: always
    depends_on:
      - komodo.mongo
    logging:
      driver: ${COMPOSE_LOGGING_DRIVER:-local}
    networks:
      - komodo
      - proxy_private
    #ports:
    #  - 9120:9120
    env_file:
      - .env
      - secrets.env
    environment:
      KOMODO_DATABASE_ADDRESS: komodo.mongo:27017
      KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
      KOMODO_DATABASE_PASSWORD: ${KOMODO_DB_PASSWORD}
    volumes:
      ## Core cache for repos for latest commit hash / contents
      - /srv/application_data/bootstrap/komodo/core/repo-cache:/repo-cache
      ## Store sync files on server
      # - /path/to/syncs:/syncs
      ## Optionally mount a custom core.config.toml
      # - /path/to/core.config.toml:/config/config.toml
    ## Allows for systemd Periphery connection at 
    ## "http://host.docker.internal:8120"
    # extra_hosts:
    #   - host.docker.internal:host-gateway
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
      # Glance
      glance.name: Komodo
      glance.icon: sh:komodo
      glance.url: https://komodo.jekotia.net
      glance.description: Container management
      glance.id: komodo
      glance.category: core
      # What's Up Docker
      wud.watch: true
      wud.watch.digest: false
      wud.link.template: https://github.com/moghtech/komodo/releases/tag/v$${major}.$${minor}.$${patch}
      wud.display.icon: sh:komodo
      wud.tag.include: ^\d+\.\d+\.\d+$$
      # Traefik
      traefik.enable: "true"
      # Traefik, Router
      traefik.http.routers.komodo.entrypoints: websecure
      traefik.http.routers.komodo.rule: Host(`${KOMODO_URL_PREFIX:-komodo.}${NETWORK_DOMAIN}`)
      traefik.http.routers.komodo.tls.certresolver: dns-cloudflare
      traefik.http.routers.komodo.tls: "true"
      # Traefik, Services
      traefik.http.routers.komodo.service: komodo
      traefik.http.services.komodo.loadbalancer.server.port: 9120
