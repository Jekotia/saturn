services:
  authentik.worker:
    image: ghcr.io/goauthentik/server:2025.6.4
    container_name: authentik.worker
    restart: always
    command: worker
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
      AUTHENTIK_REDIS__HOST: authentik.redis
      AUTHENTIK_POSTGRESQL__HOST: authentik.postgresql
      AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
      AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS}
    # `user: root` and the docker socket volume are optional.
    # See more for the docker socket integration here:
    # https://goauthentik.io/docs/outposts/integrations/docker
    # Removing `user: root` also prevents the worker from fixing the permissions
    # on the mounted folders, so when removing this make sure the folders have the correct UID/GID
    # (1000:1000 by default)
    ### user: root
    volumes:
      # - /var/run/docker.sock:/var/run/docker.sock
      - /srv/application_data/bootstrap/authentik/common/media:/media
      - /srv/application_data/bootstrap/authentik/worker/certs:/certs
      - /srv/application_data/bootstrap/authentik/common/custom-templates:/templates
    networks:
      - authentik
    env_file:
      - ../.env
    depends_on:
      authentik.postgresql:
        condition: service_healthy
      authentik.redis:
        condition: service_healthy
    labels:
      komodo.skip: true # Prevent Komodo from stopping with StopAllContainers
      # Glance
      glance.parent: authentik
      glance.name: Worker
      glance.category: core
      # What's Up Docker
      wud.watch: true
      wud.watch.digest: false
      wud.link.template: https://github.com/goauthentik/authentik/releases/tag/version%2F$${major}.$${minor}.$${patch}
      wud.display.icon: sh:authentik
      wud.tag.include: ^\d+\.\d+\.\d+$$
